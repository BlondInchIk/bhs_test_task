# Документация разработчика

Проект представляет из себя веб-приложение с использованием базы данных. Данное веб-приложение запускается при помощи инструмента контейнеризации Docker. Запуск рекомендуется выполнять на виртуальной машине, это позволит выполнять перенос проекта на другое физическое устройство, а также упростит процесс удаления и управления.

Необходимые инструменты:
- VMware Workstation (или другое стредство для виртуализации, например VirtualBox)
- Образ дистрибутива Linux (будет использован Kali linux 2024.2)

Шаги для запуска:
1. Создание виртуальной машины при помощи образа Linux
2. Установка необходимых инструментов в созданной системе
3. Настройка инструментов
4. Запуск контейнеров
5. Доступ к веб-приложению из хост машины

## Шаг 1. Создание виртуальной машины при помощи образа Linux:
1. Запустите VMware Workstation и нажмите кнопку File->New Virtual Machine
2. Выберите режим "custom"
3. Выберите версию Workstation (рекомендуется оставить по умолчанию)
4. Выберите пункт "Installer disc image file (iso)" и укажите путь до необходимого образа Linux
5. Выберите версию своей системы
6. Введите название виртуальной машины, а также укажите локальный путь 
7. Укажите необходимое количество процессоров
8. Укажите количество гигабайт оперативной памяти
9. Укажите тип сетевого соединения
10. Выберите виртуальный диск, или создайте его
11. Подтвердите настройки и запустите виртуальную машину
12. Установите Linux

## Шаг 2. Установка необходимых инструментов в созданной системе:
1. Обновите список пакетов - ```sudo apt update```
2. Установите Docker - ```sudo apt install docker.io```
3. Установите Docker-compose - ```sudo apt install docker-compose```
4. Перезагрузите систему - ```sudo reboot```

## Шаг 3. Настройка инструментов:
0. Если приложение создается в root директории, то необходимо использовать режим суперпользователя - ```sudo su```
1. Создайте директорию для проекта в желаемом месте при помощи команды mkdir - ```mkdir /путь/название директории/```
2. Перейдите в директорию при помощи команды cd - ```cd /путь до директории/```
3. Создайте файл Dockerfile при помощи команды nano - ```nano Dockerfile```
3.1. И добавьте содержимое:
```                      
FROM python:3.12.2-alpine3.19

WORKDIR /app

COPY . .

RUN pip3 install flask

RUN pip3 install mysql-connector-python

CMD ["python3", "app.py"]

```
3.2 Данный Dockerfile выполняет функцию запуска веб-приложения на python
4. А также создайте сам app.py файл со следующем содержимым:
```
from flask import Flask, jsonify
import mysql.connector

app = Flask(__name__)

def get_db_connection():
  conn = mysql.connector.connect(
   host="db",
   user="myuser",
   password="mypassword",
   database="mydb"
  )
  return conn

@app.route('/')
def get_users():
  conn = get_db_connection()
  cur = conn.cursor()
  cur.execute("SELECT * FROM users;")
  users = cur.fetchall()
  cur.close()
  conn.close()
  return jsonify(users)

if __name__ == "__main__":
  app.run(debug=True, host='0.0.0.0', port=5000)

```
4.1. Данное веб приложение будет располагаться на адресе localhost:5000(или 127.0.0.1:5000). Оно выполняет выгрузку всех записей из базы данных, конфигурация которой указана в начале файла.
5. Теперь создадим init.sql, это файл инициализации базы данных, для примера:
```
CREATE TABLE users (
 id INT AUTO_INCREMENT PRIMARY KEY,
 name VARCHAR(255) NOT NULL,
 email VARCHAR(255) UNIQUE NOT NULL
);

INSERT INTO users (name, email) VALUES
 ('John Doe', 'john.doe@example.com'),
 ('Jane Doe', 'jane.doe@example.com');

```
5.1. База данных будет состоят из одной таблицы "users", в которой будет три столбца: "уникальный номер записи", "name" и "email"
6. И наконец создайте еще один Dockerfile для базы данных, который будет называться Dockerfile-db, со следующим содержимым:
```
FROM mysql:8.0.30

ENV MYSQL_ROOT_PASSWORD=mypassword
ENV MYSQL_DATABASE=mydb
ENV MYSQL_USER=myuser
ENV MYSQL_PASSWORD=mypassword

COPY init.sql /docker-entrypoint-initdb.d/

CMD ["mysqld"]

```
6.1. Данный Dockerfile использует образ mysql для создания базы данных, а также указывает ее название и пользователя для доступа.

## Шаг 4. Запуск контейнеров:
1. Для создания и запуска контейнеров необходимо выполнить следующее:
1.1. Собрать контейнер с веб-приложением при помощи команды ```docker build -t app .```. В итоге будет создан контейнер с именем app.
1.2. Собрать контейнер с базой данных при помощи команды ```docker build -t db -f Dockerfile .```. В итоге будет создан контейнер с именем db.
1.3 Запустить контейнер с базой данных ```docker run -d -p 3306:3306 --name db db```
1.4 Запустить контейнер с веб-приложением ```docker run -d -p 5000:5000 --link db:db app```
2. Если все выполнено верно, то на адресе [127.0.0.1:5000](http://127.0.0.1:5000/) будет доступна страничка, на которой будут выведены все записи из базы данных в формате json.
3. Также для удобства можно использовать инструмент docker-compose, при  помощи которого можно запускать все контейнеры при помощи одной команды ```docker-compose up -d --build```
3.1. Для запуска при помощи docker-compose нужно создать файл docker-compose.yml, со следующим содержимым:
```
version: "3.8"

services:
  db_con:
    image: db
    build: .
    expose: ["3307"]

  app:
    image: app
    build: .
    ports:
      - "5000:5000"
    depends_on:
      - db_con
```

## Шаг 5. Доступ к веб-приложению из хост машины:
1. Для начала проверьте есть ли у вас соеденение между виртуальной машиной и хост машиной.
1.1. Для проверки надо узнать IP адрес виртуальной машины, для этого введите команду ```ip a```, и посмотрите на ip адрес eth0.
1.2. Далее на хост машине выполняете команду ```ping <адрес ВМ>```, и если выполняется пинг, то соединение есть.
2. Для доступа к веб приложение необходимо просто ввести IP адрес виртуальной машины вместе с портом 5000, например 192.168.213.134:5000
3. В результате должен открыться тот же сайт, что и на виртаульной машине.

